{% extends "base.html" %}

{% block title %}系统日志 - MTAutoFreeBT{% endblock %}
{% block page_title %}系统日志{% endblock %}

{% block page_actions %}
<div class="btn-group" role="group">
    <button type="button" class="btn btn-outline-danger" onclick="clearLogs()">
        <i class="fas fa-trash me-1"></i>清空日志
    </button>
    <button type="button" class="btn btn-outline-primary" onclick="exportLogs()">
        <i class="fas fa-download me-1"></i>导出日志
    </button>
    <button type="button" class="btn btn-outline-secondary" onclick="refreshLogs()">
        <i class="fas fa-sync-alt me-1"></i>刷新
    </button>
</div>
{% endblock %}

{% block content %}
<!-- 筛选器 -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <label for="levelFilter" class="form-label">日志级别</label>
                <select class="form-select" id="levelFilter" onchange="filterLogs()">
                    <option value="">全部级别</option>
                    <option value="DEBUG">DEBUG</option>
                    <option value="INFO">INFO</option>
                    <option value="WARNING">WARNING</option>
                    <option value="ERROR">ERROR</option>
                    <option value="CRITICAL">CRITICAL</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="dateFilter" class="form-label">日期范围</label>
                <select class="form-select" id="dateFilter" onchange="filterLogs()">
                    <option value="">全部时间</option>
                    <option value="today">今天</option>
                    <option value="yesterday">昨天</option>
                    <option value="week">最近7天</option>
                    <option value="month">最近30天</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="searchInput" class="form-label">搜索</label>
                <input type="text" class="form-control" id="searchInput" placeholder="搜索日志内容..." onkeyup="filterLogs()">
            </div>
            <div class="col-md-3">
                <label class="form-label">&nbsp;</label>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
                    <label class="form-check-label" for="autoRefresh">
                        自动刷新
                    </label>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 日志统计 -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-info" id="totalLogs">0</h5>
                <p class="card-text">总日志数</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-success" id="infoLogs">0</h5>
                <p class="card-text">信息日志</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-warning" id="warningLogs">0</h5>
                <p class="card-text">警告日志</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title text-danger" id="errorLogs">0</h5>
                <p class="card-text">错误日志</p>
            </div>
        </div>
    </div>
</div>

<!-- 日志列表 -->
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0">系统日志</h6>
            <div class="text-muted small">
                共 <span id="logCount">0</span> 条记录
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>时间</th>
                        <th>级别</th>
                        <th>消息</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="logsTableBody">
                    <!-- 日志数据将在这里动态加载 -->
                </tbody>
            </table>
        </div>
        
        <!-- 分页 -->
        <nav aria-label="日志分页">
            <ul class="pagination justify-content-center" id="pagination">
                <!-- 分页将在这里动态生成 -->
            </ul>
        </nav>
    </div>
</div>

<!-- 日志详情模态框 -->
<div class="modal fade" id="logDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">日志详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="logDetailContent">
                <!-- 详情内容将在这里动态加载 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .log-level {
        font-size: 0.75rem;
        font-weight: bold;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
    }
    
    .log-level.DEBUG {
        background-color: #e9ecef;
        color: #6c757d;
    }
    
    .log-level.INFO {
        background-color: #d1ecf1;
        color: #0c5460;
    }
    
    .log-level.WARNING {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .log-level.ERROR {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .log-level.CRITICAL {
        background-color: #f5c6cb;
        color: #721c24;
    }
    
    .log-message {
        max-width: 400px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .log-time {
        font-size: 0.875rem;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;
let currentFilters = {};
let autoRefreshInterval = null;

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    loadLogs();
    startAutoRefresh();
});

// 页面卸载时清理定时器
window.addEventListener('beforeunload', function() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
});

// 加载日志列表
async function loadLogs(page = 1) {
    try {
        showLoading();
        currentPage = page;
        
        const params = new URLSearchParams({
            page: page,
            per_page: 50,
            ...currentFilters
        });
        
        const data = await apiRequest(`/api/logs?${params}`);
        renderLogsTable(data.logs);
        renderPagination(data.current_page, data.pages, data.total);
        document.getElementById('logCount').textContent = data.total;
        
        updateLogStats(data.logs);
        hideLoading();
    } catch (error) {
        console.error('加载日志失败:', error);
        hideLoading();
    }
}

// 渲染日志表格
function renderLogsTable(logs) {
    const tbody = document.getElementById('logsTableBody');
    tbody.innerHTML = '';
    
    if (logs.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="4" class="text-center text-muted py-4">
                    <i class="fas fa-file-alt fa-2x mb-2"></i>
                    <p>暂无日志数据</p>
                </td>
            </tr>
        `;
        return;
    }
    
    logs.forEach(log => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <span class="log-time">${formatDateTime(log.created_at)}</span>
            </td>
            <td>
                <span class="log-level ${log.level}">${log.level}</span>
            </td>
            <td>
                <div class="log-message" title="${log.message}">${log.message}</div>
            </td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="showLogDetail(${log.id})">
                    <i class="fas fa-eye"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// 渲染分页
function renderPagination(currentPage, totalPages, totalItems) {
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';
    
    if (totalPages <= 1) return;
    
    // 上一页
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `
        <a class="page-link" href="#" onclick="loadLogs(${currentPage - 1})">
            <i class="fas fa-chevron-left"></i>
        </a>
    `;
    pagination.appendChild(prevLi);
    
    // 页码
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        const pageLi = document.createElement('li');
        pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
        pageLi.innerHTML = `
            <a class="page-link" href="#" onclick="loadLogs(${i})">${i}</a>
        `;
        pagination.appendChild(pageLi);
    }
    
    // 下一页
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `
        <a class="page-link" href="#" onclick="loadLogs(${currentPage + 1})">
            <i class="fas fa-chevron-right"></i>
        </a>
    `;
    pagination.appendChild(nextLi);
}

// 更新日志统计
function updateLogStats(logs) {
    const stats = {
        total: logs.length,
        info: 0,
        warning: 0,
        error: 0
    };
    
    logs.forEach(log => {
        switch (log.level) {
            case 'INFO':
                stats.info++;
                break;
            case 'WARNING':
                stats.warning++;
                break;
            case 'ERROR':
            case 'CRITICAL':
                stats.error++;
                break;
        }
    });
    
    document.getElementById('totalLogs').textContent = stats.total;
    document.getElementById('infoLogs').textContent = stats.info;
    document.getElementById('warningLogs').textContent = stats.warning;
    document.getElementById('errorLogs').textContent = stats.error;
}

// 筛选日志
function filterLogs() {
    const levelFilter = document.getElementById('levelFilter').value;
    const dateFilter = document.getElementById('dateFilter').value;
    const searchInput = document.getElementById('searchInput').value;
    
    currentFilters = {};
    
    if (levelFilter) {
        currentFilters.level = levelFilter;
    }
    if (dateFilter) {
        currentFilters.date_filter = dateFilter;
    }
    if (searchInput) {
        currentFilters.search = searchInput;
    }
    
    loadLogs(1);
}

// 显示日志详情
async function showLogDetail(logId) {
    try {
        const modal = new bootstrap.Modal(document.getElementById('logDetailModal'));
        const content = document.getElementById('logDetailContent');
        
        content.innerHTML = `
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
                <p class="mt-2">正在加载详情...</p>
            </div>
        `;
        
        modal.show();
        
        // 模拟加载详情
        setTimeout(() => {
            content.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    日志详情功能正在开发中...
                </div>
                <p>日志ID: <strong>${logId}</strong></p>
            `;
        }, 1000);
        
    } catch (error) {
        console.error('显示日志详情失败:', error);
        showNotification('加载详情失败', 'danger');
    }
}

// 清空日志
async function clearLogs() {
    if (!confirm('确定要清空所有日志吗？此操作不可恢复。')) {
        return;
    }
    
    try {
        // 这里应该调用API清空日志
        // await apiRequest('/api/logs', { method: 'DELETE' });
        
        showNotification('日志清空功能正在开发中');
        loadLogs();
    } catch (error) {
        console.error('清空日志失败:', error);
        showNotification('清空日志失败', 'danger');
    }
}

// 导出日志
function exportLogs() {
    try {
        const params = new URLSearchParams(currentFilters);
        const url = `/api/logs/export?${params}`;
        
        // 创建一个临时的下载链接
        const link = document.createElement('a');
        link.href = url;
        link.download = `logs_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showNotification('日志导出成功');
    } catch (error) {
        console.error('导出日志失败:', error);
        showNotification('导出失败', 'danger');
    }
}

// 刷新日志
function refreshLogs() {
    loadLogs(currentPage);
    showNotification('日志已刷新');
}

// 开始自动刷新
function startAutoRefresh() {
    const autoRefreshCheckbox = document.getElementById('autoRefresh');
    
    autoRefreshCheckbox.addEventListener('change', function() {
        if (this.checked) {
            startAutoRefresh();
        } else {
            stopAutoRefresh();
        }
    });
    
    if (autoRefreshCheckbox.checked) {
        autoRefreshInterval = setInterval(() => {
            loadLogs(currentPage);
        }, 30000); // 每30秒刷新一次
    }
}

// 停止自动刷新
function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
    }
}
</script>
{% endblock %} 