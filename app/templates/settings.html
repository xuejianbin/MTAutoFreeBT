{% extends "base.html" %}

{% block title %}系统设置 - MTAutoFreeBT{% endblock %}
{% block page_title %}系统设置{% endblock %}

{% block page_actions %}
<button type="button" class="btn btn-primary" onclick="saveSettings()">
    <i class="fas fa-save me-1"></i>保存设置
</button>
<button type="button" class="btn btn-outline-secondary" onclick="resetSettings()">
    <i class="fas fa-undo me-1"></i>重置
</button>
{% endblock %}

{% block content %}
<div class="row">
    <!-- 基本设置 -->
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-cog me-2"></i>基本设置
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="cycleTime" class="form-label">循环间隔 (小时)</label>
                    <input type="number" class="form-control" id="cycleTime" value="0.5" min="0.1" step="0.1">
                    <div class="form-text">系统检查新种子的时间间隔</div>
                </div>
                
                <div class="mb-3">
                    <label for="downloadPath" class="form-label">下载路径</label>
                    <input type="text" class="form-control" id="downloadPath" value="/download/PT刷流">
                    <div class="form-text">种子下载保存的路径</div>
                </div>
                
                <div class="mb-3">
                    <label for="tags" class="form-label">标签</label>
                    <input type="text" class="form-control" id="tags" value="MT刷流">
                    <div class="form-text">添加到下载种子的标签</div>
                </div>
                
                <div class="mb-3">
                    <label for="maxSize" class="form-label">最大文件大小 (GB)</label>
                    <input type="number" class="form-control" id="maxSize" value="30" min="0" step="1">
                    <div class="form-text">单个种子的最大文件大小限制</div>
                </div>
                
                <div class="mb-3">
                    <label for="minSize" class="form-label">最小文件大小 (GB)</label>
                    <input type="number" class="form-control" id="minSize" value="1" min="0" step="0.1">
                    <div class="form-text">单个种子的最小文件大小限制</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- QBittorrent设置 -->
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-server me-2"></i>QBittorrent设置
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="qbHost" class="form-label">服务器地址</label>
                    <input type="text" class="form-control" id="qbHost" value="http://localhost:8080">
                    <div class="form-text">QBittorrent Web UI地址</div>
                </div>
                
                <div class="mb-3">
                    <label for="qbUsername" class="form-label">用户名</label>
                    <input type="text" class="form-control" id="qbUsername" value="admin">
                </div>
                
                <div class="mb-3">
                    <label for="qbPassword" class="form-label">密码</label>
                    <input type="password" class="form-control" id="qbPassword" value="adminadmin">
                </div>
                
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="getMethod">
                        <label class="form-check-label" for="getMethod">
                            使用GET方法下载种子
                        </label>
                        <div class="form-text">启用后将下载种子文件而不是推送URL</div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="ipv6">
                        <label class="form-check-label" for="ipv6">
                            启用IPv6
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- 通知设置 -->
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-bell me-2"></i>通知设置
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="botToken" class="form-label">Telegram Bot Token</label>
                    <input type="text" class="form-control" id="botToken" placeholder="输入Bot Token">
                    <div class="form-text">用于发送Telegram通知</div>
                </div>
                
                <div class="mb-3">
                    <label for="chatId" class="form-label">Chat ID</label>
                    <input type="text" class="form-control" id="chatId" placeholder="输入Chat ID">
                    <div class="form-text">接收通知的聊天ID</div>
                </div>
                
                <div class="mb-3">
                    <label for="sendUrl" class="form-label">Server酱推送URL</label>
                    <input type="text" class="form-control" id="sendUrl" placeholder="输入推送URL">
                    <div class="form-text">Server酱推送服务的URL</div>
                </div>
                
                <div class="mb-3">
                    <label for="webhookUrl" class="form-label">Webhook URL</label>
                    <input type="text" class="form-control" id="webhookUrl" placeholder="输入Webhook URL">
                    <div class="form-text">自定义Webhook通知地址</div>
                </div>
                
                <div class="mb-3">
                    <label for="webhookKey" class="form-label">Webhook密钥</label>
                    <input type="text" class="form-control" id="webhookKey" placeholder="输入Webhook密钥">
                    <div class="form-text">Webhook请求的认证密钥</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 高级设置 -->
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-sliders-h me-2"></i>高级设置
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="freeTime" class="form-label">免费时间 (小时)</label>
                    <input type="number" class="form-control" id="freeTime" value="10" min="0" step="1">
                    <div class="form-text">种子免费下载的时间限制</div>
                </div>
                
                <div class="mb-3">
                    <label for="publishBefore" class="form-label">发布时间限制 (小时)</label>
                    <input type="number" class="form-control" id="publishBefore" value="24" min="0" step="1">
                    <div class="form-text">只下载指定时间内发布的种子</div>
                </div>
                
                <div class="mb-3">
                    <label for="space" class="form-label">磁盘空间限制 (GB)</label>
                    <input type="number" class="form-control" id="space" value="80" min="0" step="1">
                    <div class="form-text">保留的最小磁盘空间</div>
                </div>
                
                <div class="mb-3">
                    <label for="lsRatio" class="form-label">做种比率</label>
                    <input type="number" class="form-control" id="lsRatio" value="1" min="0" step="0.1">
                    <div class="form-text">做种数与下载数的比率要求</div>
                </div>
                
                <div class="mb-3">
                    <label for="proxy" class="form-label">代理设置</label>
                    <input type="text" class="form-control" id="proxy" placeholder="http://proxy:port">
                    <div class="form-text">HTTP代理服务器地址</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 系统信息 -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>系统信息
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-sm">
                            <tr>
                                <td><strong>应用版本:</strong></td>
                                <td id="appVersion">1.0.0</td>
                            </tr>
                            <tr>
                                <td><strong>Python版本:</strong></td>
                                <td id="pythonVersion">-</td>
                            </tr>
                            <tr>
                                <td><strong>数据库:</strong></td>
                                <td id="databaseInfo">SQLite</td>
                            </tr>
                            <tr>
                                <td><strong>运行时间:</strong></td>
                                <td id="uptime">-</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-sm">
                            <tr>
                                <td><strong>配置文件:</strong></td>
                                <td id="configFile">-</td>
                            </tr>
                            <tr>
                                <td><strong>日志文件:</strong></td>
                                <td id="logFile">-</td>
                            </tr>
                            <tr>
                                <td><strong>数据目录:</strong></td>
                                <td id="dataDir">-</td>
                            </tr>
                            <tr>
                                <td><strong>最后更新:</strong></td>
                                <td id="lastUpdate">-</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    loadSettings();
    loadSystemInfo();
});

// 加载设置
async function loadSettings() {
    try {
        // 这里应该从API加载设置
        // const settings = await apiRequest('/api/settings');
        // 暂时使用默认值
        console.log('加载设置...');
    } catch (error) {
        console.error('加载设置失败:', error);
        showNotification('加载设置失败', 'danger');
    }
}

// 保存设置
async function saveSettings() {
    try {
        const settings = {
            cycle_time: parseFloat(document.getElementById('cycleTime').value),
            download_path: document.getElementById('downloadPath').value,
            tags: document.getElementById('tags').value,
            max_size: parseInt(document.getElementById('maxSize').value),
            min_size: parseInt(document.getElementById('minSize').value),
            qb_host: document.getElementById('qbHost').value,
            qb_username: document.getElementById('qbUsername').value,
            qb_password: document.getElementById('qbPassword').value,
            get_method: document.getElementById('getMethod').checked,
            ipv6: document.getElementById('ipv6').checked,
            bot_token: document.getElementById('botToken').value,
            chat_id: document.getElementById('chatId').value,
            send_url: document.getElementById('sendUrl').value,
            webhook_url: document.getElementById('webhookUrl').value,
            webhook_key: document.getElementById('webhookKey').value,
            free_time: parseInt(document.getElementById('freeTime').value),
            publish_before: parseInt(document.getElementById('publishBefore').value),
            space: parseInt(document.getElementById('space').value),
            ls_ratio: parseFloat(document.getElementById('lsRatio').value),
            proxy: document.getElementById('proxy').value
        };
        
        // 这里应该调用API保存设置
        // await apiRequest('/api/settings', {
        //     method: 'PUT',
        //     body: JSON.stringify(settings)
        // });
        
        showNotification('设置保存成功');
        console.log('保存设置:', settings);
    } catch (error) {
        console.error('保存设置失败:', error);
        showNotification('保存设置失败', 'danger');
    }
}

// 重置设置
function resetSettings() {
    if (!confirm('确定要重置所有设置吗？')) {
        return;
    }
    
    // 重置为默认值
    document.getElementById('cycleTime').value = '0.5';
    document.getElementById('downloadPath').value = '/download/PT刷流';
    document.getElementById('tags').value = 'MT刷流';
    document.getElementById('maxSize').value = '30';
    document.getElementById('minSize').value = '1';
    document.getElementById('qbHost').value = 'http://localhost:8080';
    document.getElementById('qbUsername').value = 'admin';
    document.getElementById('qbPassword').value = 'adminadmin';
    document.getElementById('getMethod').checked = false;
    document.getElementById('ipv6').checked = false;
    document.getElementById('botToken').value = '';
    document.getElementById('chatId').value = '';
    document.getElementById('sendUrl').value = '';
    document.getElementById('webhookUrl').value = '';
    document.getElementById('webhookKey').value = '';
    document.getElementById('freeTime').value = '10';
    document.getElementById('publishBefore').value = '24';
    document.getElementById('space').value = '80';
    document.getElementById('lsRatio').value = '1';
    document.getElementById('proxy').value = '';
    
    showNotification('设置已重置');
}

// 加载系统信息
async function loadSystemInfo() {
    try {
        // 这里应该从API加载系统信息
        // const info = await apiRequest('/api/system/info');
        
        // 暂时显示静态信息
        document.getElementById('pythonVersion').textContent = '3.8+';
        document.getElementById('uptime').textContent = '正在计算...';
        document.getElementById('configFile').textContent = 'strategies/config_example.json';
        document.getElementById('logFile').textContent = 'logs/app.log';
        document.getElementById('dataDir').textContent = './data';
        document.getElementById('lastUpdate').textContent = new Date().toLocaleString('zh-CN');
        
        // 模拟计算运行时间
        setTimeout(() => {
            document.getElementById('uptime').textContent = '2小时30分钟';
        }, 1000);
        
    } catch (error) {
        console.error('加载系统信息失败:', error);
    }
}
</script>
{% endblock %} 