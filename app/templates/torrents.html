{% extends "base.html" %}

{% block title %}种子列表 - MTAutoFreeBT{% endblock %}
{% block page_title %}种子列表{% endblock %}

{% block page_actions %}
<div class="btn-group" role="group">
    <button type="button" class="btn btn-outline-primary" onclick="exportData()">
        <i class="fas fa-download me-1"></i>导出数据
    </button>
    <button type="button" class="btn btn-outline-secondary" onclick="refreshTorrents()">
        <i class="fas fa-sync-alt me-1"></i>刷新
    </button>
</div>
{% endblock %}

{% block content %}
<!-- 筛选器 -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <label for="decisionFilter" class="form-label">下载决策</label>
                <select class="form-select" id="decisionFilter" onchange="filterTorrents()">
                    <option value="">全部</option>
                    <option value="true">已下载</option>
                    <option value="false">已拒绝</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="strategyFilter" class="form-label">策略</label>
                <select class="form-select" id="strategyFilter" onchange="filterTorrents()">
                    <option value="">全部策略</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="dateFilter" class="form-label">日期范围</label>
                <select class="form-select" id="dateFilter" onchange="filterTorrents()">
                    <option value="">全部时间</option>
                    <option value="today">今天</option>
                    <option value="week">最近7天</option>
                    <option value="month">最近30天</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="searchInput" class="form-label">搜索</label>
                <input type="text" class="form-control" id="searchInput" placeholder="搜索种子名称..." onkeyup="filterTorrents()">
            </div>
        </div>
    </div>
</div>

<!-- 种子列表 -->
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0">种子记录</h6>
            <div class="text-muted small">
                共 <span id="totalCount">0</span> 条记录
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>种子名称</th>
                        <th>大小</th>
                        <th>折扣</th>
                        <th>做种/下载</th>
                        <th>决策</th>
                        <th>策略</th>
                        <th>优先级</th>
                        <th>时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="torrentsTableBody">
                    <!-- 数据将在这里动态加载 -->
                </tbody>
            </table>
        </div>
        
        <!-- 分页 -->
        <nav aria-label="种子列表分页">
            <ul class="pagination justify-content-center" id="pagination">
                <!-- 分页将在这里动态生成 -->
            </ul>
        </nav>
    </div>
</div>

<!-- 详情模态框 -->
<div class="modal fade" id="torrentDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">种子详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="torrentDetailContent">
                <!-- 详情内容将在这里动态加载 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;
let currentFilters = {};

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    loadTorrents();
    loadStrategyOptions();
});

// 加载种子列表
async function loadTorrents(page = 1) {
    try {
        showLoading();
        currentPage = page;
        
        const params = new URLSearchParams({
            page: page,
            per_page: 20,
            ...currentFilters
        });
        
        const data = await apiRequest(`/api/torrents?${params}`);
        renderTorrentsTable(data.torrents);
        renderPagination(data.current_page, data.pages, data.total);
        document.getElementById('totalCount').textContent = data.total;
        
        hideLoading();
    } catch (error) {
        console.error('加载种子列表失败:', error);
        hideLoading();
    }
}

// 渲染种子表格
function renderTorrentsTable(torrents) {
    const tbody = document.getElementById('torrentsTableBody');
    tbody.innerHTML = '';
    
    if (torrents.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="text-center text-muted py-4">
                    <i class="fas fa-inbox fa-2x mb-2"></i>
                    <p>暂无数据</p>
                </td>
            </tr>
        `;
        return;
    }
    
    torrents.forEach(torrent => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-torrent text-primary"></i>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <div class="fw-bold">${torrent.name}</div>
                        <small class="text-muted">ID: ${torrent.torrent_id}</small>
                    </div>
                </div>
            </td>
            <td>
                <span class="badge bg-light text-dark">${torrent.size_human}</span>
            </td>
            <td>
                ${torrent.discount ? `<span class="badge bg-warning">${torrent.discount}</span>` : '-'}
            </td>
            <td>
                <div class="d-flex flex-column">
                    <small class="text-success">↑ ${torrent.seeders || 0}</small>
                    <small class="text-danger">↓ ${torrent.leechers || 0}</small>
                </div>
            </td>
            <td>
                ${torrent.download_decision ? 
                    '<span class="badge bg-success">已下载</span>' : 
                    '<span class="badge bg-danger">已拒绝</span>'
                }
            </td>
            <td>
                <span class="badge bg-info">${torrent.strategy_used || '未知'}</span>
            </td>
            <td>
                <div class="progress" style="height: 20px;">
                    <div class="progress-bar" role="progressbar" 
                         style="width: ${Math.min(torrent.priority_score * 100, 100)}%"
                         title="${torrent.priority_score || 0}">
                        ${(torrent.priority_score || 0).toFixed(2)}
                    </div>
                </div>
            </td>
            <td>
                <small>${formatDateTime(torrent.created_at)}</small>
            </td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="showTorrentDetail(${torrent.id})">
                    <i class="fas fa-eye"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// 渲染分页
function renderPagination(currentPage, totalPages, totalItems) {
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';
    
    if (totalPages <= 1) return;
    
    // 上一页
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `
        <a class="page-link" href="#" onclick="loadTorrents(${currentPage - 1})">
            <i class="fas fa-chevron-left"></i>
        </a>
    `;
    pagination.appendChild(prevLi);
    
    // 页码
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        const pageLi = document.createElement('li');
        pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
        pageLi.innerHTML = `
            <a class="page-link" href="#" onclick="loadTorrents(${i})">${i}</a>
        `;
        pagination.appendChild(pageLi);
    }
    
    // 下一页
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `
        <a class="page-link" href="#" onclick="loadTorrents(${currentPage + 1})">
            <i class="fas fa-chevron-right"></i>
        </a>
    `;
    pagination.appendChild(nextLi);
}

// 加载策略选项
async function loadStrategyOptions() {
    try {
        const data = await apiRequest('/api/strategies');
        const strategyFilter = document.getElementById('strategyFilter');
        
        data.strategies.forEach(strategy => {
            const option = document.createElement('option');
            option.value = strategy.name;
            option.textContent = strategy.name;
            strategyFilter.appendChild(option);
        });
    } catch (error) {
        console.error('加载策略选项失败:', error);
    }
}

// 筛选种子
function filterTorrents() {
    const decisionFilter = document.getElementById('decisionFilter').value;
    const strategyFilter = document.getElementById('strategyFilter').value;
    const dateFilter = document.getElementById('dateFilter').value;
    const searchInput = document.getElementById('searchInput').value;
    
    currentFilters = {};
    
    if (decisionFilter) {
        currentFilters.download_decision = decisionFilter;
    }
    if (strategyFilter) {
        currentFilters.strategy_used = strategyFilter;
    }
    if (dateFilter) {
        currentFilters.date_filter = dateFilter;
    }
    if (searchInput) {
        currentFilters.search = searchInput;
    }
    
    loadTorrents(1);
}

// 显示种子详情
async function showTorrentDetail(torrentId) {
    try {
        // 这里可以添加获取单个种子详情的API调用
        // 暂时显示基本信息
        const modal = new bootstrap.Modal(document.getElementById('torrentDetailModal'));
        const content = document.getElementById('torrentDetailContent');
        
        content.innerHTML = `
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
                <p class="mt-2">正在加载详情...</p>
            </div>
        `;
        
        modal.show();
        
        // 模拟加载详情
        setTimeout(() => {
            content.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    种子详情功能正在开发中...
                </div>
            `;
        }, 1000);
        
    } catch (error) {
        console.error('显示种子详情失败:', error);
        showNotification('加载详情失败', 'danger');
    }
}

// 导出数据
function exportData() {
    try {
        const params = new URLSearchParams(currentFilters);
        const url = `/api/torrents/export?${params}`;
        
        // 创建一个临时的下载链接
        const link = document.createElement('a');
        link.href = url;
        link.download = `torrents_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showNotification('数据导出成功');
    } catch (error) {
        console.error('导出数据失败:', error);
        showNotification('导出失败', 'danger');
    }
}

// 刷新种子列表
function refreshTorrents() {
    loadTorrents(currentPage);
    showNotification('数据已刷新');
}
</script>
{% endblock %} 